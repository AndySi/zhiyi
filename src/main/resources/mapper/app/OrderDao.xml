<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.idou.modules.app.dao.OrderDao">
    <select id="queryList" resultType="com.idou.modules.app.dto.ApiOrderVo">
        SELECT
        o.*,
        u.`nickName`,
        i.`name` AS itemName,
        i.`coverUrl`,
        i.`describe`
        FROM `t_order` o, `t_user` u,`t_item` i
        WHERE o.`userId` = u.`id` AND o.`itemId` = i.`id`
        <if test="orderNo!=null and orderNo!=''">
            AND o.`orderNo` LIKE CONCAT('%', #{orderNo} ,'%')
        </if>
        <if test="orderState != null">
            AND o.`orderState` = #{orderState}
        </if>
        <if test="offset != null and limit != null">
            LIMIT #{offset}, #{limit}
        </if>
    </select>

    <select id="queryTotal" resultType="int">
        SELECT
          COUNT(*)
        FROM `t_order` o, `t_user` u,`t_item` i
        WHERE o.`userId` = u.`id` AND o.`itemId` = i.`id`
        <if test="orderNo!=null and orderNo!=''">
            AND o.`orderNo` LIKE CONCAT('%', #{orderNo} ,'%')
        </if>
        <if test="orderState != null">
            AND o.`orderState` = #{orderState}
        </if>
    </select>

    <update id="update" parameterType="com.idou.modules.app.dto.ApiOrderVo">
        UPDATE
          `t_order`
        SET
          `orderNum` = #{orderNum},
          `orderMoney` = #{orderMoney},
          `receiver` = #{receiver},
          `tel` = #{tel}
        WHERE `id` = #{id}
    </update>

    <select id="queryListByUserId" resultType="com.idou.modules.app.dto.ApiOrderVo">
        SELECT
        o.*,
        i.`name` AS itemName,
        i.`coverUrl`,
        i.`describe`
        FROM `t_order` o, `t_user` u,`t_item` i
        WHERE o.`userId` = u.`id` AND o.`itemId` = i.`id`
        ORDER BY o.`createTime` DESC
        <if test="offset != null and limit != null">
            LIMIT #{offset}, #{limit}
        </if>
    </select>

    <!-- 下单 -->
    <select id="saveRobByProcedure" statementType="CALLABLE">
        call execute_todayRob(
          #{orderNo,jdbcType=VARCHAR,mode = IN},
          #{itemId,jdbcType=BIGINT,mode = IN},
          #{orderNum,jdbcType=INTEGER,mode = IN},
          #{orderMoney,jdbcType=DECIMAL,mode = IN},
          #{addressId,jdbcType=BIGINT,mode = IN},
          #{userId,jdbcType=BIGINT,mode = IN},
          #{receiver,jdbcType=VARCHAR,mode = IN},
          #{tel,jdbcType=VARCHAR,mode = IN},
          #{payType,jdbcType=INTEGER,mode = IN},
          #{createTime,jdbcType=DATE,mode = IN},
          #{expireTime,jdbcType=DATE,mode = IN},
          #{result,jdbcType=INTEGER,mode = OUT}
        )
    </select>

    <!-- 根据订单号查询订单详情 -->
    <select id="queryDetail" resultType="com.idou.modules.app.dto.ApiOrderVo">
        SELECT
          o.*,
          i.`name` AS itemName
        FROM
          `t_order` o,
          `t_item` i
        WHERE o.`itemId` = i.`id`
          AND o.`userId` = #{userId}
          AND o.`orderNo` = #{orderNo}
    </select>

    <!-- 根据订单号查询订单信息 -->
    <select id="queryInfo" resultType="com.idou.modules.app.entity.ApiOrderEntity">
        SELECT
          `orderState`,
          `createTime`,
          `expireTime`
        FROM
          `t_order`
        WHERE `userId` = #{userId}
          AND `orderNo` = #{orderNo}
    </select>

    <!-- 订单状态修改 -->
    <update id="updateState" parameterType="com.idou.modules.app.entity.ApiOrderEntity">
        UPDATE
          `t_order`
        SET
          `orderState` = #{orderState}
        WHERE `orderNo` = #{orderNo}
        AND `userId` = #{userId}
    </update>
</mapper>